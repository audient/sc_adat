
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ADAT Transmit &mdash; S/PDIF 1v0 documentation</title>
    <link rel="stylesheet" href="_static/xdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1v0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://mathjax.connectmv.com/MathJax.js"></script>
    <script type="text/javascript" src="_static/xcomment.js"></script>
    <link rel="top" title="S/PDIF 1v0 documentation" href="index.html" />
    <link rel="prev" title="ADAT Receive" href="api-rx.html" /> 

<script>
function setheight() {
h1 = document.getElementById('d1').style.height;
h2 = document.getElementById('d2').style.height;

if (parseInt(h1) > parseInt(h2)) {
document.getElementById('d2').style.height=h1 + "px";
}
else {
document.getElementById('d1').style.height=h2 + "px";
}

}
</script>
</head>

<body onload="setheight();">

  

    <div class="document" id='d1'>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
<div style="float: right">
<a href="api-rx.html"
                        title="previous chapter"> &lt&lt </a>
</div>

            
  <div class="section" id="adat-transmit">
<h1>ADAT Transmit<a class="headerlink" href="#adat-transmit" title="Permalink to this headline">¶</a></h1>
<p>There are two modules that can produce an ADAT signal. The simplest module
is a single thread that inputs samples over a channel and that outputs data
on a 1-bit port. A more complex module has a thread that inputs samples
over a channel and that produces an ADAT signal onto a second channel.
Another thread has to copy this data from the channel onto a port. The
latter is useful if the ADAT output port is, for example, on a different
core. See the examples section on how to use this.</p>
<p>An identical protocol is used by both modules for inputting sample values
to be transmitted over ADAT. The first word transmitted over the
chanend should be the multiplier of the master clock (either 1024 or 512),
the second word should be the SMUX setting (either 0 or 2), then there should be N
x 8 words of sample values, terminated by an <tt class="docutils literal"><span class="pre">XS1_CT_END</span></tt> control token. If no
control token is sent, the transmission process will not terminate, and an
infinite stream of ADAT data can be sent.</p>
<p>The multiplier is the ratio between the master clock and the bit-rate; 1024
refers to a 49.152 Mhz masterclock, 512 assumes a 24.576 MHz master clock.</p>
<p>The output of the ADAT transmit thread has to be synchronised with an
external flip-flop. In order to make sure that the flip-flop captures the
signal on the right edge, the output port should be set up as follows:</p>
<div class="highlight-none"><div class="highlight"><pre>set_clock_src(mck_blk, mck);        // Connect Master Clock Block to mclk pin
set_port_clock(adat_port, mck_blk); // Set ADAT_tx to be clocked from mck_blk
set_clock_fall_delay(mck_blk, 7);   // Delay falling edge of mck_blk
start_clock(mck_blk);               // Start mck_blk
</pre></div>
</div>
<div class="section" id="api">
<h2>API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="adat_tx">
void <tt class="descname">adat_tx</tt><big>(</big>chanend<em>&nbsp;c_data</em>, chanend<em>&nbsp;c_port</em><big>)</big><a class="headerlink" href="#adat_tx" title="Permalink to this definition">¶</a></dt>
<dd><p>Function that takes data over a channel end, and that outputs this in ADAT format onto a 1-bit port.</p>
<p>The 1-bit port should be clocked by the master-clock, and an external flop should be used to precisely align the edge of the signal to the master-clock.</p>
<p>Data should be send onto c_data using outuint only, the first two values should be The multiplier and the smux values, after that output any number of eight samples (24-bit, right aligned), and if the process is to be terminated send it an control token 1.</p>
<p>The data is output onto a channel, which a separate process should output to a port. This process should byte-reverse every word read over the channel, and then output the reversed word to a buffered 1-bit port.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>c_data</strong> &#8211; Channel over which to send sample values to the transmitter</li>
<li><strong>c_port</strong> &#8211; Channel on which to generate the ADAT stream</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="adat_tx_port">
void <tt class="descname">adat_tx_port</tt><big>(</big>chanend<em>&nbsp;c_data</em>, buffered out port:32<em>&nbsp;p_data</em><big>)</big><a class="headerlink" href="#adat_tx_port" title="Permalink to this definition">¶</a></dt>
<dd><p>Function that takes data over a channel end, and that outputs this in ADAT format onto a 1-bit port.</p>
<p>The 1-bit port should be clocked by the master-clock, and an external flop should be used to precisely align the edge of the signal to the master-clock.</p>
<p>Data should be send onto c_data using outuint only, the first two values should be The multiplier and the smux values, after that output any number of eight samples (24-bit, right aligned), and if the process is to be terminated send it an control token 1.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>c_data</strong> &#8211; Channel over which to send sample values to the transmitter</li>
<li><strong>p_data</strong> &#8211; 1-bit port on which to generate the ADAT stream</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Below we show two example programs: a program that uses the direct
interface, and a program that uses an intermediate thread to output to the
port.</p>
<div class="section" id="example-of-direct-port-code">
<h3>Example of direct port code<a class="headerlink" href="#example-of-direct-port-code" title="Permalink to this headline">¶</a></h3>
<p>The output port needs to be declared as a
buffered port, and the master clock input must be declared as an unbuffered
input port. A clock block is also required:</p>
<div class="highlight-none"><div class="highlight"><pre>buffered out port:32 adat_port = XS1_PORT_1P;
in port mck = XS1_PORT_1O;
clock mck_blk = XS1_CLKBLK_2;
</pre></div>
</div>
<p>The ports need to be setup so that the output port is clocked of the master
clock with a suitable delay (to enable the external flop to latch the
signal). Do not forget to start the clock block, otherwise nothing shall happen:</p>
<div class="highlight-none"><div class="highlight"><pre>void setupClocks() {
    set_clock_src(mck_blk, mck);
    set_clock_fall_delay(mck_blk, 7);   // XAI2 board, set to appropriate value for board.

    set_port_clock(adat_port, mck_blk);
    start_clock(mck_blk);
}
</pre></div>
</div>
<p>The data generator should first transmit the clock multiplier and the SMUX
flags, prior to transmitting data. To terminate, send an END token:</p>
<div class="highlight-none"><div class="highlight"><pre>void generateData(chanend c_data) {
	outuint(c_data, 512);    // master clock multiplier (1024, 256, or 512)
	outuint(c_data, 0);      // SMUX flag (0, 2, or 4)
	for (int i = 0; i &lt; 1000; i++) {
		outuint(c_data, i);  // left aligned data (only 24 bits will be used)
	}
	outct(c_data, XS1_CT_END);
}
</pre></div>
</div>
<p>The main program simply forks the data generating thread and the transmitter in
parallel in two threads. Prior to starting the transmitter, the clocks
should be set up:</p>
<div class="highlight-none"><div class="highlight"><pre>
</pre></div>
</div>
</div>
<div class="section" id="example-of-adat-with-an-extra-thread">
<h3>Example of ADAT with an extra thread<a class="headerlink" href="#example-of-adat-with-an-extra-thread" title="Permalink to this headline">¶</a></h3>
<p>The output port needs to be declared as a
buffered port, and the master clock input must be declared as an unbuffered
input port. A clock block is also required:</p>
<div class="highlight-none"><div class="highlight"><pre>buffered out port:32 adat_port = XS1_PORT_1P;
in port mck = XS1_PORT_1O;
clock mck_blk = XS1_CLKBLK_2;
</pre></div>
</div>
<p>The ports need to be setup so that the output port is clocked of the master
clock with a suitable delay (to enable the external flop to latch the
signal). Do not forget to start the clock block, otherwise nothing shall happen:</p>
<div class="highlight-none"><div class="highlight"><pre>void setupClocks() {
    set_clock_src(mck_blk, mck);
    set_clock_fall_delay(mck_blk, 7);   // XAI2 board, set to appropriate value for board.
    set_port_clock(adat_port, mck_blk);
    start_clock(mck_blk);
}
</pre></div>
</div>
<p>The thread that drives the port should input words from the channel, and
output them with <em>reversed byte order</em>. Note that this activity of INPUT,
BYTEREV and OUTPUT takes only three instructions and can often be merged
with other threads; for example if there is an I2S thread that delivers
data syncrhonised to the same master clock, then that thread can
simultaneously drive the ADAT and I2S ports:</p>
<div class="highlight-none"><div class="highlight"><pre>void drivePort(chanend c_port) {
    setupClocks();
	while (1) {
		adat_port &lt;: byterev(inuint(c_port));
	}
}
</pre></div>
</div>
<p>The data generator should first transmit the clock multiplier and the SMUX
flags, prior to transmitting data. To terminate, send an END token:</p>
<div class="highlight-none"><div class="highlight"><pre>void generateData(chanend c_data) {
	outuint(c_data, 512);    // master clock multiplier (1024, 256, or 512)
	outuint(c_data, 0);      // SMUX flag (0, 2, or 4)
	for (int i = 0; i &lt; 1000; i++) {
		outuint(c_data, i);  // left aligned data (only 24 bits will be used)
	}
	outct(c_data, XS1_CT_END);
}
</pre></div>
</div>
<p>The main program simply forks the data generating thread and the transmitter in
parallel in two threads. Prior to starting the transmitter, the clocks
should be set up:</p>
<div class="highlight-none"><div class="highlight"><pre>
</pre></div>
</div>
</div>
</div>
</div>



          </div>
        </div>
      </div>
      <div class="sphinxsidebar" id='d2'>
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">S/PDIF (1v0)</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="summary.html">ADAT software</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-rx.html">ADAT Receive</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">ADAT Transmit</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#api">API</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example">Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-of-direct-port-code">Example of direct port code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-of-adat-with-an-extra-thread">Example of ADAT with an extra thread</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none;margin-bottom: 10px;">
  <h3>Search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>



    <div class="footer">
    </div>
  </body>
</html>



